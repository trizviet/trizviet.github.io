---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import { collectCategories, toCategorySlug } from "../lib/categories";
import { getEntryHref, type ArticleEntry } from "../lib/entries";

const posts = await getCollection("posts");
const welcome = await getCollection("welcome");

const items: ArticleEntry[] = [...posts, ...welcome].sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

const categories = collectCategories(items);
const featuredCategories = categories.slice(0, 12);

const formatDate = (date: Date) =>
  new Intl.DateTimeFormat("en-CA", {
    year: "numeric",
    month: "short",
    day: "2-digit"
  }).format(date);

const latestHref = items[0] ? getEntryHref(items[0]) : "/";
---

<BaseLayout title="Notes on Building and Learning">
  <section class="hero">
    <p class="hero-kicker">Case studies and practical frameworks</p>
    <h1>Technical writing, project notes, and practical guides</h1>
    <p class="hero-lead">
      I use this blog to publish concise write-ups on tools, workflows, and lessons
      learned while building software.
    </p>
    <div class="hero-actions">
      <a class="hero-cta" href={latestHref}>Read the latest post</a>
    </div>
  </section>

  <section>
    <div class="section-head">
      <h2>Browse Categories</h2>
      <a class="section-link" href="/categories/">View all</a>
    </div>
    <ul class="category-grid">
      {featuredCategories.map((category) => (
        <li class="category-card">
          <a class="category-name" href={`/categories/${category.slug}/`}>{category.name}</a>
          <p class="category-count">{category.count} post{category.count === 1 ? "" : "s"}</p>
        </li>
      ))}
    </ul>
  </section>

  <section>
    <h2>Latest Posts</h2>
    <ul class="post-list">
      {items.map((entry, idx) => (
        <li class="post-card" style={`--stagger:${idx};`}>
          <p class="meta-row">
            <span class="meta-type">{entry.collection === "welcome" ? "Welcome" : "Post"}</span>
            <span class="meta">{formatDate(entry.data.date)}</span>
          </p>
          <h3><a href={getEntryHref(entry)}>{entry.data.title}</a></h3>
          {entry.data.description && <p>{entry.data.description}</p>}
          {entry.data.categories.length > 0 && (
            <p class="badges">
              {entry.data.categories.map((category) => (
                <a class="badge badge-link" href={`/categories/${toCategorySlug(category)}/`}>
                  {category}
                </a>
              ))}
            </p>
          )}
        </li>
      ))}
    </ul>
  </section>
</BaseLayout>
